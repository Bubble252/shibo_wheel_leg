# PID调参工具 - 波形显示功能说明

## 功能概述

已为PID调参工具添加**实时波形显示**功能,可以同时观察每个PID控制器的**目标值**和**当前值**,便于直观评估控制效果。

## 主要特性

### 1. ESP32端数据采集
- 在每个控制循环中输出关键数据
- 数据格式: `#DATA,ID,Target,Control`
- 示例: `#DATA,A,7.4000,6.8523` (角度PID: 目标7.4°, 当前6.85°)

### 2. Python端波形显示
- **双曲线显示**: 蓝色=目标值, 红色=当前值
- **实时更新**: 每次收到数据自动刷新
- **缓存管理**: 最多保存500个采样点(约5秒)
- **控制按钮**:
  - 🗑 清除波形: 清空历史数据
  - ⏸ 暂停: 冻结波形,方便观察

## 数据映射关系

| 命令ID | PID控制器 | 目标值含义 | 当前值含义 |
|--------|----------|-----------|-----------|
| A | 角度PID | 角度零点偏置 | 实际姿态角 |
| B | 角速度PID | 0 | 实际角速度 |
| C | 位移PID | 位移零点 | 当前位移 |
| D | 速度PID | 目标速度(摇杆) | 当前速度 |
| E | YAW角度PID | 目标YAW角 | 当前YAW角 |
| F | YAW角速度PID | 0 | 当前YAW角速度 |
| H | LQR输出PID | 0 | LQR总输出 |
| K | Roll角度PID | 0 | 当前Roll角度 |

## 使用步骤

### 1. 安装依赖
```bash
pip install pyqtgraph
```

### 2. 编译上传ESP32
```bash
cd c:\Users\bubble\Documents\PlatformIO\Projects\shibo_wheel_leg
pio run --target upload
```

### 3. 运行Python工具
```bash
cd qt_board
python pid_tuner.py
```

### 4. 观察波形
1. 连接串口
2. 切换到要观察的PID标签页
3. 观察实时波形:
   - **蓝色曲线**: 控制器的目标值
   - **红色曲线**: 传感器实际测量值
   - **跟随效果**: 红线跟随蓝线越紧密,控制效果越好

## 调参技巧

### 观察波形特征判断参数效果:

1. **响应速度慢** (红线跟不上蓝线)
   - → 增加P参数

2. **震荡** (红线来回摆动)
   - → 减小P参数
   - → 增加D参数抑制震荡

3. **稳态误差** (红线接近但不重合)
   - → 增加I参数消除静差

4. **超调过大** (红线冲过蓝线)
   - → 减小P参数
   - → 增加D参数

## 注意事项

1. **数据流量**: ESP32每个loop()循环发送8条数据,注意串口性能
2. **波形刷新**: 只有当前激活的标签页会显示波形
3. **内存占用**: 每个面板最多保存500个数据点,超出自动删除旧数据
4. **暂停功能**: 可以暂停波形观察特定时刻的数据

## 故障排除

### 波形不更新
- 检查ESP32是否正常运行 (`pio device monitor` 查看串口输出)
- 确认串口连接正常
- 查看日志区是否有错误信息

### 波形抖动严重
- 这是正常现象,反映了真实的控制过程
- 可以通过调整PID参数改善
- 也可以在ESP32端添加滤波

### Python报错缺少pyqtgraph
```bash
pip install pyqtgraph
```

## 数据格式说明

ESP32发送格式:
```
#DATA,A,7.4000,6.8523
#DATA,B,0.0000,0.1234
...
```

Python解析逻辑:
```python
if line.startswith("#DATA,"):
    parts = line.split(',')
    panel_id = parts[1]    # 'A', 'B', 'C'...
    target = float(parts[2])   # 目标值
    control = float(parts[3])  # 当前值
```
